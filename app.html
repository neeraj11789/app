<!DOCTYPE html>
<html>
<head>
    <title>RealTime Update Events On Google Maps</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
            integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXzC2KuC_lu7CcjdzD8gA5MSbckipd4Hw&callback=initMap&libraries=&v=weekly"
            async
    ></script>

</head>

<style type="text/css">
    #map {
        height: 400px;
        /* The height is 400 pixels */
        width: 100%;
        /* The width is the width of the web page */
      }
	.panel{
		padding-top: 20px;
		padding-bottom: 20px;
	}
	h1{
		color: blue;
	}
	.pstyle{
		font-size: 2rem;
		font-family: verdana, sans-serif;
	}



</style>

<script type="text/javascript">
		$(document).ready(function(){
            $("button").click(function(){
                const vid =  $("input:text").val();
                const urlEndPoint = 'https://afternoon-wave-33826.herokuapp.com/v1/vehicles/'+ vid +'/locations/subscribe';
                const eventSource = new EventSource(urlEndPoint);
                $('.panel-primary').text('Location Update Ping ' + vid)

                eventSource.addEventListener("msg", function(event){
                    console.log(event.data);
                    var l = JSON.parse(event.data);
                    addBlock(l.lat, l.lng, l.pingTime);
                });

                function addBlock(lat, lng, tme){
                    console.log(lat, lng, tme);
                    changeMarkerPosition(marker, lat, lng);
                }

                function changeMarkerPosition(marker, lat, lng) {
                    var latlng = new google.maps.LatLng(lat, lng);
                    marker.setPosition(latlng);
                }

                function initMap() {
                   // The location of Uluru
                    const location = { lat: 52.45097, lng: 13.46139 };
                    // The map, centered at Uluru
                    const map = new google.maps.Map(document.getElementById("map"), {
                      zoom: 16,
                      center: location,
                    });
                    const iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
                    // The marker, positioned at Uluru
                    const marker = new google.maps.Marker({
                      position: location,
                      map: map,
                      icon: iconBase + 'bus.png'
                    });
                    return marker;
                }
                var marker = initMap();
            });
	    });

	// Initialize and add the map
      function initMap() {
        console.log("map initialized");
      }

</script>

<body>
<h1 class="text-center">Door2Door Vehicle Google Maps Client</h1>
<div class="container text-center pstyle" id="pack">
    <p>VehicleId: <input type="text" name="vehicle"></p>
    <button>Subscribe To Updates</button>
    <br/>
    <br/>
    <div class="panel pstyle panel-primary">
        Location Update Ping
    </div>
</div>

<!--The div element for the map -->
<div id="map"></div>

</body>
</html>